{% extends 'ctf/ctf_home.html' %}
{% load static %}

{% block title %}PROFIL // {{ user.username }}{% endblock %}

{% block content %}
<style>
    /* Shared Cyber Card Style */
    .cyber-card {
        background: #0b1120; /* Midnight Blue */
        border: 1px solid rgba(16, 185, 129, 0.4); /* Emerald Border */
        border-radius: 24px;
        box-shadow: 0 0 20px rgba(0,0,0,0.3);
        position: relative;
        overflow: hidden;
    }

    /* Animation */
    @keyframes scan {
        0% { top: -100%; }
        100% { top: 100%; }
    }
    .scan-line {
        position: absolute;
        top: -100%; left: 0; width: 100%; height: 100%;
        background: linear-gradient(180deg, transparent 40%, rgba(16, 185, 129, 0.1) 50%, transparent 60%);
        animation: scan 6s infinite linear;
        pointer-events: none;
    }

    /* Avatar Upload */
    .avatar-wrapper {
        position: relative;
        width: 140px; height: 140px;
        margin: 0 auto;
    }
    .avatar-img {
        width: 100%; height: 100%;
        object-fit: cover;
        border-radius: 24px;
        border: 2px solid rgba(16, 185, 129, 0.3);
    }
    .upload-overlay {
        position: absolute;
        inset: 0;
        background: rgba(0,0,0,0.6);
        border-radius: 24px;
        display: flex; align-items: center; justify-content: center;
        opacity: 0;
        transition: opacity 0.2s;
        cursor: pointer;
    }
    .avatar-wrapper:hover .upload-overlay { opacity: 1; }

    /* Stats Grid */
    .stat-box {
        background: rgba(15, 23, 42, 0.6);
        border: 1px solid rgba(255,255,255,0.05);
        border-radius: 16px;
        padding: 1.5rem;
        text-align: center;
        transition: 0.3s;
    }
    .stat-box:hover {
        background: rgba(16, 185, 129, 0.05);
        border-color: rgba(16, 185, 129, 0.3);
        transform: translateY(-2px);
    }
</style>

<div class="max-w-7xl mx-auto px-4 py-28 min-h-screen">
    
    <!-- Breadcrumb -->
    <div class="flex items-center gap-3 mb-8 text-sm text-slate-400 font-mono uppercase tracking-widest pl-2 border-l-2 border-emerald-500">
         <span class="text-emerald-400">AGENTS</span> // DATABASE <i class="fas fa-chevron-right text-[10px]"></i> {{ user.username }}
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- LEFT: PROFILE CARD -->
        <div class="lg:col-span-1">
            <div class="cyber-card p-8 flex flex-col items-center text-center">
                <div class="scan-line"></div>
                
                <!-- Background Decoration -->
                <div class="absolute top-0 right-0 w-full h-full bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-10 pointer-events-none"></div>
                <div class="absolute -top-20 -left-20 w-64 h-64 bg-emerald-500/5 rounded-full blur-3xl pointer-events-none"></div>

                <div class="text-[10px] font-mono text-emerald-500 mb-6 tracking-widest border border-emerald-500/20 px-2 py-0.5 rounded bg-emerald-500/5">
                    ID: {{ user.id|stringformat:"04d" }}
                </div>

                <!-- Avatar Upload -->
                <div class="avatar-wrapper mb-6">
                    {% if profile.avatar %}
                    <img src="{{ profile.avatar.url }}" class="avatar-img shadow-2xl">
                    {% else %}
                    <div class="avatar-img bg-slate-800 flex items-center justify-center text-4xl font-bold text-white border-2 border-emerald-500/20">
                        {{ user.username.0|upper }}
                    </div>
                    {% endif %}
                    
                    <form method="POST" enctype="multipart/form-data" id="avatar-form">
                        {% csrf_token %}
                        <input type="file" name="avatar" id="avatar-input" class="hidden" accept="image/*" onchange="document.getElementById('avatar-form').submit();">
                    </form>
                    <div class="upload-overlay" onclick="document.getElementById('avatar-input').click();">
                        <i class="fas fa-camera text-2xl text-emerald-400"></i>
                    </div>
                </div>

                <h1 class="text-3xl font-bold text-white mb-2">{{ user.username }}</h1>
                <div class="text-slate-400 text-xs font-mono mb-8">{{ user.email|default:"Email biriktirilmagan" }}</div>

                <div class="w-full space-y-3">
                    <div class="flex justify-between items-center p-3 bg-white/5 rounded-lg border border-white/5 text-sm">
                        <span class="text-slate-500">Qo'shilgan sanasi</span>
                        <span class="text-white font-mono">{{ user.date_joined|date:"d.m.Y" }}</span>
                    </div>
                    
                    <div class="flex justify-between items-center p-3 bg-white/5 rounded-lg border border-white/5 text-sm">
                        <span class="text-slate-500">Daraja (Rank)</span>
                        <span class="text-emerald-400 font-bold font-mono">#{{ rank }}</span>
                    </div>
                </div>

                <a href="{% url 'logout' %}" class="mt-8 w-full py-3 rounded-xl border border-red-500/20 bg-red-500/5 text-red-500 hover:bg-red-500 hover:text-white transition-all text-xs font-bold tracking-widest flex items-center justify-center gap-2">
                    <i class="fas fa-power-off"></i> TIZIMDAN CHIQISH
                </a>
            </div>
        </div>

        <!-- RIGHT: STATS & LOGS -->
        <div class="lg:col-span-2 flex flex-col gap-6">
            
            <!-- Stats Row -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="stat-box">
                    <div class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mb-2">Jami Ball</div>
                    <div class="text-3xl font-black text-white font-mono">{{ profile.total_points }}</div>
                </div>
                <div class="stat-box">
                    <div class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mb-2">Yechilganlar</div>
                    <div class="text-3xl font-black text-emerald-400 font-mono">{{ solved_challenges.count }}</div>
                </div>
                 <div class="stat-box">
                    <div class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mb-2">Status</div>
                    <div class="text-xl font-bold text-white font-mono pt-1">
                        {% if solved_challenges.count > 10 %}ELITE{% elif solved_challenges.count > 5 %}PRO{% else %}ROOKIE{% endif %}
                    </div>
                </div>
            </div>

            <!-- Activity Log Card -->
            <div class="cyber-card flex-grow h-[500px] flex flex-col">
                <div class="p-6 border-b border-white/10 flex justify-between items-center bg-slate-900/50">
                    <div class="flex items-center gap-3">
                        <div class="w-3 h-3 rounded-full bg-red-500"></div>
                        <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
                        <div class="w-3 h-3 rounded-full bg-green-500"></div>
                        <span class="text-xs font-mono text-slate-400 ml-2">activity_log.sh</span>
                    </div>
                    <div class="text-xs text-slate-600 font-mono">{{ solved_challenges.count }} records found</div>
                </div>

                <div class="overflow-y-auto custom-scrollbar p-0 flex-grow bg-[#0b1120]">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-slate-900/50 text-[10px] uppercase text-slate-500 font-mono sticky top-0 z-10">
                            <tr>
                                <th class="p-4 pl-6">Status</th>
                                <th class="p-4">Masala</th>
                                <th class="p-4 text-right">Ball</th>
                                <th class="p-4 text-right pr-6">Vaqt</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-white/5 text-sm">
                            {% for solved in solved_challenges %}
                            <tr class="hover:bg-white/[0.02] transition-colors group">
                                <td class="p-4 pl-6 text-emerald-500 font-mono text-xs font-bold">[SOLVED]</td>
                                <td class="p-4">
                                    <a href="{% url 'challenge_detail' solved.challenge.id %}" class="text-white font-bold hover:text-emerald-400 transition-colors">
                                        {{ solved.challenge.title }}
                                    </a>
                                </td>
                                <td class="p-4 text-right text-emerald-400 font-mono font-bold">+{{ solved.challenge.points }}</td>
                                <td class="p-4 text-right pr-6 text-slate-500 text-xs font-mono group-hover:text-slate-400">
                                    {{ solved.solved_at|date:"d.m.Y H:i" }}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="p-12 text-center text-slate-600 font-mono text-xs">
                                    > Hozircha hech qanday faoliyat yo'q.<br>
                                    > Masalalarni yechishni boshlang.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>
</div>
{% endblock %}