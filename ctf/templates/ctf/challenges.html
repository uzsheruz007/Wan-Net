{% extends 'ctf/ctf_home.html' %}

{% block title %}Challenges{% endblock %}

{% block content %}
<style>
    /* New Card Style based on Team Dashboard */
    .cyber-card {
        background: #0b1120; /* Midnight Blue */
        border: 1px solid rgba(16, 185, 129, 0.4); /* Emerald Border */
        border-radius: 20px;
        overflow: hidden;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        flex-direction: column;
        height: 100%;
        position: relative;
    }

    .cyber-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 20px 40px -5px rgba(0, 0, 0, 0.5), 0 0 15px rgba(16, 185, 129, 0.2);
        border-color: #10b981;
    }

    .card-header {
        background: radial-gradient(circle at center, #1e293b, #020617);
        height: 140px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        position: relative;
    }

    .card-body {
        padding: 1.5rem;
        flex-grow: 1;
        background: #0f172a;
        display: flex;
        flex-direction: column;
    }

    /* Solved Overlay */
    .solved-overlay {
        position: absolute;
        inset: 0;
        background: rgba(0,0,0,0.85);
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 50;
        opacity: 0;
        transition: opacity 0.3s;
        pointer-events: none;
    }
    .cyber-card:has(.solved-overlay) .solved-overlay { opacity: 1; pointer-events: auto; }

    .stamp {
        border: 4px solid;
        padding: 10px 20px;
        font-weight: 900;
        text-transform: uppercase;
        transform: rotate(-12deg);
        font-family: 'Orbitron', sans-serif;
    }
    .stamp-success { color: #10b981; border-color: #10b981; }
    .stamp-fail { color: #ef4444; border-color: #ef4444; transform: rotate(12deg); }

    /* Filter Buttons */
    .filter-btn {
        background: rgba(15, 23, 42, 0.6);
        border: 1px solid rgba(255,255,255,0.1);
        padding: 10px 20px;
        border-radius: 8px;
        color: #94a3b8;
        font-size: 11px;
        font-family: 'JetBrains Mono', monospace;
        transition: 0.2s;
        margin-right: 8px;
    }
    .filter-btn:hover, .filter-btn.active {
        background: rgba(16, 185, 129, 0.1);
        border-color: #10b981;
        color: #10b981;
    }
</style>

<div class="max-w-7xl mx-auto px-4 py-8 pt-32 min-h-screen relative z-10">

    <!-- HERO HEADER -->
    <div class="mb-12 animate-entry">
        <h1 class="text-5xl md:text-6xl font-black text-white font-display uppercase tracking-tighter mb-4 drop-shadow-2xl">
            Topshiriqlar <span class="text-transparent bg-clip-text bg-gradient-to-r from-emerald-400 to-emerald-600">Bazasi</span>
        </h1>
        <p class="text-slate-400 font-mono text-sm max-w-2xl border-l-2 border-emerald-500/50 pl-4">
            > Markazlashtirilgan o'ljalar taxtasiga xush kelibsiz.<br>
            > Maxfiy ma'lumotlarni ko'rish va deshifrlashni boshlash uchun topshiriqni tanlang.
        </p>
    </div>

    <!-- HUD STATS (Style like Profile/Team) -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-10 animate-entry delay-100">
        <div class="bg-[#0b1120] border border-emerald-500/30 rounded-xl p-6 relative overflow-hidden group">
            <div class="absolute inset-0 bg-emerald-500/5 group-hover:bg-emerald-500/10 transition-colors"></div>
            <div class="relative z-10 text-center">
                <div class="text-[10px] text-slate-500 uppercase font-bold tracking-widest mb-1">MAVJUD TOPSHIRIQLAR</div>
                <div class="text-3xl font-black text-white font-mono">{{ total_challenges }}</div>
            </div>
        </div>
        <div class="bg-[#0b1120] border border-white/10 rounded-xl p-6 relative overflow-hidden group">
            <div class="relative z-10 text-center">
                <div class="text-[10px] text-slate-500 uppercase font-bold tracking-widest mb-1">KO'RSATILMOQDA</div>
                <div class="text-3xl font-black text-emerald-100 font-mono">{{ displayed_count }}</div>
            </div>
        </div>
        <div class="bg-[#0b1120] border border-white/10 rounded-xl p-6 relative overflow-hidden md:block hidden">
            <div class="relative z-10 text-center">
                <div class="text-[10px] text-slate-500 uppercase font-bold tracking-widest mb-1">TIZIM HOLATI</div>
                 <div class="text-emerald-400 text-sm mt-2 flex items-center gap-2 justify-center font-bold">
                    <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse shadow-[0_0_10px_#10b981]"></span> ONLINE
                </div>
            </div>
        </div>
    </div>

    <!-- FILTERS -->
    <div class="flex overflow-x-auto pb-6 mb-4 animate-entry delay-200 no-scrollbar">
        <a href="?" class="filter-btn {% if not request.GET.category %}active{% endif %}">
            BARCHA FAYLLAR
        </a>
        {% if user.is_authenticated %}
        <a href="?category=solved" class="filter-btn {% if request.GET.category == 'solved' %}active{% endif %}">
            YECHILGAN
        </a>
        <a href="?category=failed" class="filter-btn {% if request.GET.category == 'failed' %}active{% endif %}">
            YECHILMAGAN
        </a>
        {% endif %}
        {% for cat in all_categories %}
        <a href="?category={{ cat.code }}" class="filter-btn {% if cat.selected %}active{% endif %}">
            #{{ cat.name|upper }}
        </a>
        {% endfor %}
    </div>

    <!-- CHALLENGE GRID -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        {% for challenge in challenges %}
        <a href="{% url 'challenge_detail' challenge.id %}" class="block h-full animate-entry delay-300">
            <div class="cyber-card">
                
                <!-- Graphic Header -->
                <div class="card-header">
                     <!-- Green Box CTF Text -->
                    <div class="border-2 border-emerald-500 px-5 py-2 bg-black z-10 shadow-[0_0_20px_rgba(16,185,129,0.2)]">
                        <span class="text-3xl font-black text-emerald-500 font-mono tracking-[0.2em] drop-shadow-[0_0_8px_rgba(16,185,129,0.8)]">
                            CTF
                        </span>
                    </div>
                    
                    <!-- Background Grid Effect -->
                    <div class="absolute inset-0 opacity-20 pointer-events-none" 
                         style="background-image: linear-gradient(#10b981 1px, transparent 1px), linear-gradient(90deg, #10b981 1px, transparent 1px); background-size: 20px 20px;">
                    </div>

                    <!-- PTS Badge -->
                    <div class="absolute top-3 right-3 font-mono text-[10px] font-bold text-slate-400 bg-slate-900/80 px-2 py-1 rounded border border-white/10">
                        {{ challenge.points }} PTS
                    </div>
                </div>

                <!-- Content -->
                <div class="card-body">
                    <div class="text-[10px] text-emerald-500 font-mono mb-2 uppercase tracking-widest font-bold opacity-80">{{ challenge.category }}</div>
                    <h3 class="text-white font-bold text-lg leading-tight mb-4 group-hover:text-emerald-400 transition-colors">
                        {{ challenge.title|truncatechars:40 }}
                    </h3>
                    
                    <div class="mt-auto flex items-center justify-between pt-4 border-t border-white/5">
                        <div class="font-mono text-[10px] text-slate-500 uppercase">
                             QIYINCHILIK: <span class="text-white font-bold">NORMAL</span>
                        </div>
                        <i class="fas fa-arrow-right text-slate-600 text-xs"></i>
                    </div>
                </div>

                <!-- Overlays -->
                {% if challenge.is_solved %}
                <div class="solved-overlay">
                    <div class="stamp stamp-success">YECHILGAN</div>
                </div>
                {% elif challenge.has_failed_attempt %}
                <div class="solved-overlay">
                    <div class="stamp stamp-fail">YECHILMAGAN</div>
                </div>
                {% endif %}
            </div>
        </a>
        {% empty %}
        <div class="col-span-full py-24 text-center border-2 border-dashed border-emerald-500/20 rounded-2xl bg-emerald-500/5">
            <h3 class="text-emerald-500 font-bold text-xl mb-2">Ma'lumot topilmadi</h3>
            <p class="text-slate-400 font-mono text-sm">Tanlangan kategoriyada topshiriqlar mavjud emas.</p>
            <a href="?" class="mt-6 inline-block px-6 py-2 bg-emerald-500 text-white rounded font-bold hover:bg-emerald-400 transition-colors">
                Barchasini ko'rsatish
            </a>
        </div>
        {% endfor %}
    </div>

    <!-- PAGINATION -->
    {% if challenges.has_other_pages %}
    <div class="flex justify-center mt-12 gap-3 animate-entry delay-300">
        {% if challenges.has_previous %}
        <a href="?page={{ challenges.previous_page_number }}{% if selected_category %}&category={{ selected_category }}{% endif %}" 
           class="px-4 py-2 rounded-lg border border-white/10 bg-[#0b1120] text-slate-400 hover:text-white hover:border-emerald-500 transition-colors font-mono text-xs font-bold">
           &lt; OLDINGI
        </a>
        {% endif %}
        
        <span class="px-4 py-2 rounded-lg bg-emerald-500/10 border border-emerald-500/30 text-emerald-400 font-mono text-xs font-bold">
            {{ challenges.number }}
        </span>

        {% if challenges.has_next %}
        <a href="?page={{ challenges.next_page_number }}{% if selected_category %}&category={{ selected_category }}{% endif %}" 
           class="px-4 py-2 rounded-lg border border-white/10 bg-[#0b1120] text-slate-400 hover:text-white hover:border-emerald-500 transition-colors font-mono text-xs font-bold">
           KEYINGI &gt;
        </a>
        {% endif %}
    </div>
    {% endif %}

</div>
{% endblock %}